<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bot Anunciador v9.0 ‚Äî Painel</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a3e;
            --bg-card: #1e1e42;
            --bg-hover: #2a2a5e;
            --bg-input: #252550;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99,102,241,0.3);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --border: #2d2d6a;
            --sidebar-width: 220px;
            --topbar-height: 52px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; height: 100vh; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* LOGIN */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-overlay.hidden { display: none; }
        .login-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 36px; width: 360px; max-width: 95vw; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .login-box h2 { margin-bottom: 6px; font-size: 22px; }
        .login-box p { color: var(--text-secondary); margin-bottom: 20px; font-size: 13px; }
        .login-box .ig { margin-bottom: 14px; text-align: left; }
        .login-box .ig label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; font-weight: 500; }
        .login-box input { width: 100%; padding: 9px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 13px; outline: none; }
        .login-box input:focus { border-color: var(--accent); }
        .login-box button { width: 100%; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 6px; }
        .login-box button:hover { background: var(--accent-hover); }
        .login-error { color: var(--danger); font-size: 12px; margin-top: 10px; display: none; }

        /* LAYOUT */
        .app { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; transition: width 0.3s; }
        .sb-header { padding: 14px; border-bottom: 1px solid var(--border); text-align: center; }
        .sb-header h1 { font-size: 15px; font-weight: 700; background: linear-gradient(135deg, var(--accent), #a855f7); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent; }
        .sb-header .ver { font-size: 10px; color: var(--text-muted); }
        .sb-nav { flex: 1; padding: 6px; overflow-y: auto; }
        .nav-sec { font-size: 9px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; padding: 10px 10px 4px; }
        .nav-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 7px; color: var(--text-secondary); cursor: pointer; font-size: 12px; font-weight: 500; margin-bottom: 1px; transition: all 0.15s; }
        .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 2px 8px var(--accent-glow); }
        .nav-item i { width: 16px; text-align: center; font-size: 12px; }
        .nav-item .badge { margin-left: auto; background: var(--danger); color: white; font-size: 9px; padding: 1px 5px; border-radius: 8px; font-weight: 600; }
        .sb-footer { padding: 10px 14px; border-top: 1px solid var(--border); font-size: 10px; }
        .sb-footer .user-info { display: flex; align-items: center; gap: 6px; padding: 6px; background: var(--bg-input); border-radius: 6px; margin-bottom: 6px; }
        .sb-footer .role { font-size: 9px; padding: 1px 5px; border-radius: 3px; font-weight: 600; }
        .sb-footer .role.admin { background: var(--accent); color: white; }
        .sb-footer .role.viewer { background: var(--warning); color: #000; }
        .sb-footer .role.client { background: var(--success); color: white; }
        .sb-footer .logout-btn { width: 100%; padding: 5px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 5px; color: var(--text-secondary); cursor: pointer; font-size: 10px; }
        .sb-footer .logout-btn:hover { background: var(--danger); color: white; }

        /* MAIN */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
        .topbar { height: var(--topbar-height); background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
        .topbar-title { font-size: 15px; font-weight: 600; }
        .topbar-right { display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .status-dot.offline { background: var(--danger); }
        .topbar-stat { font-size: 11px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; }
        .content { flex: 1; overflow-y: auto; padding: 16px; }
        .page { display: none; }
        .page.active { display: block; }

        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 16px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
        .stat-card:hover { border-color: var(--accent); }
        .stat-card .si { font-size: 18px; margin-bottom: 4px; }
        .stat-card .sv { font-size: 22px; font-weight: 700; }
        .stat-card .sl { font-size: 11px; color: var(--text-secondary); }

        /* PANELS */
        .panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 14px; overflow: hidden; }
        .panel-h { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; font-weight: 600; font-size: 13px; }
        .panel-b { padding: 14px; }
        .panel-b.np { padding: 0; }

        /* GRID */
        .dash-grid { display: grid; grid-template-columns: 1fr 320px; gap: 14px; }
        .dash-left, .dash-right { min-width: 0; }

        /* BUTTONS */
        .btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary); cursor: pointer; font-size: 11px; font-weight: 500; display: inline-flex; align-items: center; gap: 5px; transition: all 0.15s; white-space: nowrap; }
        .btn:hover { background: var(--bg-hover); border-color: var(--accent); }
        .btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn.primary:hover { background: var(--accent-hover); }
        .btn.danger { background: var(--danger); border-color: var(--danger); color: white; }
        .btn.success { background: var(--success); border-color: var(--success); color: white; }
        .btn.sm { padding: 4px 8px; font-size: 10px; }
        .btn:disabled, .btn.no-perm { opacity: 0.35; cursor: not-allowed; pointer-events: none; }

        /* INPUTS */
        .inp { padding: 7px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text-primary); font-size: 12px; outline: none; width: 100%; }
        .inp:focus { border-color: var(--accent); }
        .inp-row { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
        select.inp { cursor: pointer; }

        /* BOTS */
        .bot-card { display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); gap: 10px; }
        .bot-card:hover { background: var(--bg-hover); }
        .bot-card:last-child { border-bottom: none; }
        .bot-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .bot-dot.on { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .bot-info { flex: 1; min-width: 0; }
        .bot-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bot-srv { font-size: 10px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bot-motd { font-size: 9px; color: var(--accent); font-style: italic; }
        .bot-mini { display: flex; gap: 6px; font-size: 10px; color: var(--text-secondary); flex-shrink: 0; flex-wrap: wrap; }
        .bot-actions { display: flex; gap: 3px; flex-shrink: 0; }

        /* CHAT */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - var(--topbar-height) - 32px); }
        .chat-toolbar { display: flex; gap: 6px; padding: 10px 0; flex-wrap: wrap; align-items: center; }
        .chat-msgs { flex: 1; overflow-y: auto; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; }
        .chat-msg { padding: 4px 8px; border-radius: 5px; margin-bottom: 3px; font-size: 12px; line-height: 1.4; }
        .chat-msg:hover { background: var(--bg-hover); }
        .chat-msg .ct { color: var(--text-muted); font-size: 10px; }
        .chat-msg .cs { color: var(--accent); font-size: 10px; cursor: pointer; }
        .chat-msg .cm { color: var(--text-muted); font-style: italic; font-size: 10px; }
        .chat-msg .cu { color: var(--success); font-weight: 600; }
        .chat-msg .cu.bot-user { color: var(--warning); }
        .chat-msg .cx { color: var(--text-primary); }
        .chat-msg.mentioned { background: rgba(99,102,241,0.12); border-left: 3px solid var(--accent); }
        .chat-msg .sentiment-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 3px; }
        .chat-msg .sentiment-dot.positive { background: var(--success); }
        .chat-msg .sentiment-dot.negative { background: var(--danger); }
        .chat-input { display: flex; gap: 6px; padding: 10px 0; flex-wrap: wrap; }

        /* SERVER CARDS */
        .srv-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .srv-card:hover { border-color: var(--accent); }
        .srv-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; flex-wrap: wrap; gap: 4px; }
        .srv-name { font-weight: 600; font-size: 12px; }
        .srv-motd { font-size: 11px; color: var(--text-secondary); font-style: italic; margin-bottom: 4px; }
        .srv-meta { display: flex; gap: 8px; flex-wrap: wrap; font-size: 10px; color: var(--text-muted); }
        .srv-tag { font-size: 9px; padding: 1px 6px; border-radius: 3px; font-weight: 600; }
        .srv-tag.survival { background: #22c55e22; color: var(--success); }
        .srv-tag.pvp { background: #ef444422; color: var(--danger); }
        .srv-tag.criativo { background: #3b82f622; color: var(--info); }
        .srv-tag.minigame { background: #f59e0b22; color: var(--warning); }
        .srv-tag.smp { background: #a855f722; color: #a855f7; }
        .srv-tag.lojinha { background: #ec489922; color: #ec4899; }
        .srv-plugins { font-size: 10px; color: var(--text-muted); margin-top: 4px; padding: 4px 8px; background: var(--bg-input); border-radius: 4px; }
        .rep-bar { width: 100%; height: 3px; background: var(--bg-input); border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .rep-bar .fill { height: 100%; border-radius: 2px; transition: width 0.5s; }

        /* LOGS */
        .log-e { padding: 4px 8px; font-size: 11px; font-family: monospace; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .log-t { color: var(--text-muted); }

        /* MSG LIST */
        .msg-item { display: flex; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); gap: 8px; }
        .msg-idx { font-size: 10px; color: var(--text-muted); min-width: 20px; }
        .msg-txt { flex: 1; font-size: 12px; word-break: break-word; }

        /* BLACKLIST */
        .bl-item { display: flex; align-items: center; padding: 6px 12px; border-bottom: 1px solid var(--border); gap: 8px; font-size: 12px; }
        .bl-type { font-size: 9px; padding: 1px 6px; border-radius: 3px; font-weight: 600; }
        .bl-type.perm { background: #ef444422; color: var(--danger); }
        .bl-type.temp { background: #f59e0b22; color: var(--warning); }

        /* LEARNING */
        .word-cloud { display: flex; flex-wrap: wrap; gap: 5px; padding: 10px; }
        .word-tag { padding: 3px 8px; border-radius: 5px; font-size: 11px; background: var(--bg-input); border: 1px solid var(--border); display: inline-flex; align-items: center; gap: 3px; }
        .word-tag:hover { border-color: var(--accent); }
        .word-tag .cnt { color: var(--text-muted); font-size: 9px; }
        .word-del { color: var(--danger); cursor: pointer; font-weight: 700; font-size: 13px; }
        .word-del:hover { color: #ff6b6b; }

        /* TERMINAL */
        .term-screen { background: #0a0a1a; border: 1px solid var(--border); border-radius: 10px; font-family: monospace; font-size: 11px; color: #c8d6e5; height: calc(100vh - 320px); overflow-y: auto; padding: 10px; }
        .term-line { padding: 1px 0; line-height: 1.4; white-space: pre-wrap; word-break: break-all; }
        .term-line .tt { color: #576574; }
        .term-line.err .tv { color: #ee5a24; }
        .term-line.ok .tv { color: #2ed573; }
        .term-line.warn .tv { color: #ffa502; }

        /* SYS INFO */
        .sys-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 14px; }
        .sys-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; }
        .sys-card .sv { font-size: 18px; font-weight: 700; color: var(--accent); }
        .sys-card .sl { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

        /* CHART */
        .chart-bars { display: flex; align-items: flex-end; gap: 3px; height: 100px; padding-top: 6px; }
        .chart-bar { flex: 1; background: var(--accent); border-radius: 2px 2px 0 0; min-width: 8px; transition: height 0.5s; position: relative; cursor: pointer; }
        .chart-bar:hover { background: var(--accent-hover); }
        .chart-bar .bl { position: absolute; bottom: -16px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--text-muted); white-space: nowrap; }
        .chart-bar .bv { position: absolute; top: -14px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--text-secondary); }

        /* TOP SERVER CHAT */
        .tsc { max-height: 350px; overflow-y: auto; }
        .tsc-h { padding: 8px 12px; background: var(--bg-input); border-bottom: 1px solid var(--border); font-size: 11px; }
        .tsc-m { padding: 3px 12px; font-size: 11px; border-bottom: 1px solid rgba(255,255,255,0.02); }

        /* PLAYER CARD */
        .player-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .player-card:hover { border-color: var(--accent); }
        .player-head { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .player-avatar { width: 32px; height: 32px; border-radius: 4px; }
        .player-name { font-size: 13px; font-weight: 600; }
        .player-role { font-size: 9px; padding: 1px 5px; border-radius: 3px; font-weight: 600; background: var(--accent); color: white; }
        .player-stats { display: flex; gap: 10px; font-size: 10px; color: var(--text-muted); flex-wrap: wrap; }
        .player-toxic { color: var(--danger); font-weight: 600; }

        /* KEYS */
        .key-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .key-card:hover { border-color: var(--accent); }
        .key-value { font-family: monospace; font-size: 11px; color: var(--accent); background: var(--bg-input); padding: 4px 8px; border-radius: 4px; user-select: all; word-break: break-all; }
        .key-meta { display: flex; gap: 8px; font-size: 10px; color: var(--text-muted); margin-top: 6px; flex-wrap: wrap; }

        /* ADS */
        .ad-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .ad-progress { width: 100%; height: 4px; background: var(--bg-input); border-radius: 2px; overflow: hidden; margin-top: 6px; }
        .ad-progress .fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 1s; }

        /* INVENTORY */
        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 4px; }
        .inv-slot { background: var(--bg-input); border: 1px solid var(--border); border-radius: 4px; padding: 6px; text-align: center; font-size: 10px; }
        .inv-slot.armor { border-color: var(--accent); }
        .inv-slot .inv-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .inv-slot .inv-count { color: var(--text-muted); }

        /* VIEWER */
        .viewer-frame { width: 100%; height: 400px; border: 1px solid var(--border); border-radius: 10px; background: #000; }

        /* TOAST */
        .toast-c { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 6px; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 7px; padding: 8px 14px; font-size: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); animation: slideIn 0.3s ease; max-width: 320px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            :root { --sidebar-width: 0px; }
            .sidebar { position: fixed; left: -260px; width: 260px; height: 100vh; transition: left 0.3s; z-index: 1000; }
            .sidebar.open { left: 0; }
            .mobile-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }
            .mobile-overlay.show { display: block; }
            .mobile-menu-btn { display: flex !important; }
            .dash-grid { grid-template-columns: 1fr; }
            .topbar { padding: 0 10px; }
            .content { padding: 10px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .chat-toolbar { gap: 4px; }
            .chat-input { flex-direction: column; }
            .chat-input .inp { max-width: 100% !important; }
            .inp-row { flex-direction: column; }
            .inp-row .inp { max-width: 100% !important; }
            .sys-grid { grid-template-columns: repeat(2, 1fr); }
            .topbar-stat:not(:first-child) { display: none; }
        }
        @media (min-width: 769px) {
            .mobile-menu-btn { display: none !important; }
            .mobile-overlay { display: none !important; }
        }
        @media (max-width: 900px) and (min-width: 769px) {
            .sidebar { width: 50px; }
            .nav-item span, .nav-sec, .sb-header h1, .sb-header .ver, .sb-footer .user-info span, .nav-item .badge { display: none; }
            .nav-item { justify-content: center; padding: 8px; }
            .dash-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <h2>ü§ñ Bot Anunciador</h2>
        <p>v9.0 ‚Äî Login</p>
        <div class="ig"><label>Usu√°rio / Key</label><input type="text" id="loginUser" placeholder="Usu√°rio ou API Key" autocomplete="off"></div>
        <div class="ig"><label>Senha</label><input type="password" id="loginPass" placeholder="Senha" autocomplete="off"></div>
        <button onclick="doLogin()" id="loginBtn">Entrar</button>
        <div class="login-error" id="loginError"></div>
    </div>
</div>

<!-- MOBILE OVERLAY -->
<div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

<!-- APP -->
<div class="app" id="app" style="display:none;">
    <div class="sidebar" id="sidebar">
        <div class="sb-header"><h1>Bot Anunciador</h1><div class="ver">v9.0</div></div>
        <div class="sb-nav">
            <div class="nav-sec">Principal</div>
            <div class="nav-item active" data-page="dashboard" onclick="nav('dashboard')"><i class="fas fa-home"></i><span>Dashboard</span></div>
            <div class="nav-item" data-page="bots" onclick="nav('bots')"><i class="fas fa-robot"></i><span>Bots</span><span class="badge" id="botsCount">0</span></div>
            <div class="nav-item" data-page="chat" onclick="nav('chat')"><i class="fas fa-comments"></i><span>Chat</span></div>
            <div class="nav-item" data-page="learning" onclick="nav('learning')"><i class="fas fa-brain"></i><span>Aprendizado</span></div>
            <div class="nav-sec">Gerenciar</div>
            <div class="nav-item" data-page="servers" onclick="nav('servers')"><i class="fas fa-server"></i><span>Servidores</span></div>
            <div class="nav-item" data-page="players" onclick="nav('players')"><i class="fas fa-users"></i><span>Players</span></div>
            <div class="nav-item" data-page="inventory" onclick="nav('inventory')"><i class="fas fa-box"></i><span>Invent√°rio</span></div>
            <div class="nav-item" data-page="messages" onclick="nav('messages')"><i class="fas fa-bullhorn"></i><span>Mensagens</span></div>
            <div class="nav-item" data-page="blacklist" onclick="nav('blacklist')"><i class="fas fa-ban"></i><span>Blacklist</span></div>
            <div class="nav-sec">An√°lise</div>
            <div class="nav-item" data-page="analytics" onclick="nav('analytics')"><i class="fas fa-chart-bar"></i><span>Analytics</span></div>
            <div class="nav-item" data-page="viewer" onclick="nav('viewer')"><i class="fas fa-eye"></i><span>Viewer 3D</span></div>
            <div class="nav-item" data-page="terminal" onclick="nav('terminal')"><i class="fas fa-terminal"></i><span>Terminal</span></div>
            <div class="nav-item" data-page="logs" onclick="nav('logs')"><i class="fas fa-list-alt"></i><span>Logs</span></div>
            <div class="nav-sec admin-only">Admin</div>
            <div class="nav-item admin-only" data-page="keys" onclick="nav('keys')"><i class="fas fa-key"></i><span>Keys/Ads</span></div>
            <div class="nav-item" data-page="settings" onclick="nav('settings')"><i class="fas fa-cog"></i><span>Config</span></div>
        </div>
        <div class="sb-footer">
            <div class="user-info"><i class="fas fa-user" style="color:var(--accent);font-size:11px;"></i><span id="sbUser">‚Äî</span><span class="role" id="sbRole">‚Äî</span></div>
            <button class="logout-btn" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </div>
    <div class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:10px;">
                <button class="btn sm mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <div class="topbar-title" id="pageTitle">Dashboard</div>
            </div>
            <div class="topbar-right">
                <div class="topbar-stat"><span class="status-dot" id="botDot"></span><span id="botText">Offline</span></div>
                <div class="topbar-stat"><i class="fas fa-clock"></i><span id="uptime">0m</span></div>
                <div class="topbar-stat"><i class="fas fa-memory"></i><span id="memText">‚Äî</span></div>
                <div class="topbar-stat"><i class="fas fa-tachometer-alt"></i><span id="tpsText">‚Äî</span></div>
            </div>
        </div>
        <div class="content">

            <!-- DASHBOARD -->
            <div class="page active" id="p-dashboard">
                <div class="stats-grid">
                    <div class="stat-card"><div class="si">ü§ñ</div><div class="sv" id="sBots">0</div><div class="sl">Bots Ativos</div></div>
                    <div class="stat-card"><div class="si">üñ•Ô∏è</div><div class="sv" id="sServers">0</div><div class="sl">Servidores</div></div>
                    <div class="stat-card"><div class="si">üí¨</div><div class="sv" id="sMsgs">0</div><div class="sl">Mensagens</div></div>
                    <div class="stat-card"><div class="si">üö´</div><div class="sv" id="sBl">0</div><div class="sl">Blacklist</div></div>
                    <div class="stat-card"><div class="si">üë•</div><div class="sv" id="sPlayers">0</div><div class="sl">Players</div></div>
                    <div class="stat-card"><div class="si">üì¢</div><div class="sv" id="sAds">0</div><div class="sl">An√∫ncios</div></div>
                    <div class="stat-card"><div class="si">üìä</div><div class="sv" id="sImpressions">0</div><div class="sl">Impress√µes</div></div>
                </div>
                <div class="dash-grid">
                    <div class="dash-left">
                        <div class="panel"><div class="panel-h"><span>üèÜ Top 3</span></div><div class="panel-b np" id="topSrvPanel"><div style="padding:16px;color:var(--text-muted);text-align:center;font-size:12px;">Aguardando...</div></div></div>
                        <div class="panel"><div class="panel-h"><span>ü§ñ Bots</span><div><button class="btn sm primary admin-only" onclick="cmd('announce')"><i class="fas fa-bullhorn"></i></button> <button class="btn sm danger admin-only" onclick="cmd('restartBots')"><i class="fas fa-redo"></i></button></div></div><div class="panel-b np" id="botsPanel"><div style="padding:16px;color:var(--text-muted);text-align:center;font-size:12px;">Nenhum bot</div></div></div>
                        <div class="panel"><div class="panel-h"><span>üìã Logs</span></div><div class="panel-b np" id="dashLogs" style="max-height:180px;overflow-y:auto;"></div></div>
                    </div>
                    <div class="dash-right">
                        <div class="panel"><div class="panel-h"><span>üí¨ Chat Popular</span></div><div class="panel-b np"><div class="tsc" id="tscPanel"><div style="padding:16px;color:var(--text-muted);text-align:center;font-size:12px;">Aguardando...</div></div></div></div>
                        <div class="panel"><div class="panel-h"><span>üîó Conectar</span></div><div class="panel-b"><div class="inp-row"><input class="inp admin-only" id="cIp" placeholder="ip:porta"><button class="btn primary admin-only" onclick="connectSrv()"><i class="fas fa-plug"></i></button></div></div></div>
                        <div class="panel"><div class="panel-h"><span>üìä Pico</span></div><div class="panel-b"><div class="chart-bars" id="peakChart" style="height:70px;"></div><div style="height:18px;"></div></div></div>
                    </div>
                </div>
            </div>

            <!-- BOTS -->
            <div class="page" id="p-bots">
                <div class="inp-row"><input class="inp admin-only" id="cIp2" placeholder="ip:porta" style="max-width:260px;"><button class="btn primary admin-only" onclick="connectSrv2()"><i class="fas fa-plug"></i> Conectar</button><button class="btn danger admin-only" onclick="cmd('disconnect_server','all')"><i class="fas fa-power-off"></i> Todos</button></div>
                <div class="panel"><div class="panel-h"><span>ü§ñ Bots</span></div><div class="panel-b np" id="botsFull"></div></div>
            </div>

            <!-- CHAT -->
            <div class="page" id="p-chat">
                <div class="chat-container">
                    <div class="chat-toolbar">
                        <select class="inp" id="chatFilter" style="max-width:220px;" onchange="filterChat()"><option value="all">Todos servidores</option></select>
                        <select class="inp" id="chatSType" style="max-width:110px;"><option value="all">Tudo</option><option value="player">Jogador</option><option value="message">Mensagem</option><option value="positive">üòä Positivo</option><option value="negative">üò° Negativo</option></select>
                        <input class="inp" id="chatSearch" placeholder="Pesquisar..." style="max-width:200px;" oninput="filterChat()">
                        <button class="btn sm" onclick="filterChat()"><i class="fas fa-search"></i></button>
                        <button class="btn sm" onclick="dlChat()"><i class="fas fa-download"></i></button>
                        <button class="btn sm danger admin-only" onclick="cmd('clearChatDatabase')"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="chat-msgs" id="chatMsgs"></div>
                    <div class="chat-input">
                        <select class="inp admin-only" id="chatSendSrv" style="max-width:180px;"><option value="all">Todos</option></select>
                        <input class="inp admin-only" id="chatSendMsg" placeholder="Mensagem..." onkeydown="if(event.key==='Enter')sendChat()">
                        <button class="btn primary admin-only" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
                        <input class="inp admin-only" id="chatSendCmd" placeholder="/cmd" style="max-width:150px;" onkeydown="if(event.key==='Enter')sendCmd()">
                        <button class="btn admin-only" onclick="sendCmd()"><i class="fas fa-terminal"></i></button>
                    </div>
                </div>
            </div>

            <!-- LEARNING -->
            <div class="page" id="p-learning">
                <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));">
                    <div class="stat-card"><div class="si">üß†</div><div class="sv" id="lTotal">0</div><div class="sl">Analisadas</div></div>
                    <div class="stat-card"><div class="si">üìù</div><div class="sv" id="lMin">0%</div><div class="sl">Min√∫scula</div></div>
                    <div class="stat-card"><div class="si">üî§</div><div class="sv" id="lAcento">0%</div><div class="sl">Acento</div></div>
                    <div class="stat-card"><div class="si">‚úÇÔ∏è</div><div class="sv" id="lAbrev">0%</div><div class="sl">Abrevia√ß√µes</div></div>
                </div>
                <div class="inp-row"><button class="btn primary" onclick="reqLearn()"><i class="fas fa-sync"></i> Atualizar</button><button class="btn success" onclick="exportLearn()"><i class="fas fa-download"></i> Exportar</button></div>
                <div class="panel"><div class="panel-h"><span>üó£Ô∏è G√≠rias</span></div><div class="panel-b"><div class="word-cloud" id="giriasC"></div></div></div>
                <div class="panel"><div class="panel-h"><span>üí¨ Express√µes</span></div><div class="panel-b"><div class="word-cloud" id="exprC"></div></div></div>
                <div class="panel"><div class="panel-h"><span>üìú Frases</span></div><div class="panel-b np" id="frasesP"></div></div>
            </div>

            <!-- SERVERS -->
            <div class="page" id="p-servers">
                <div class="inp-row">
                    <select class="inp" id="srvCatF" style="max-width:140px;" onchange="renderSrvs()"><option value="all">Todas</option><option value="survival">Survival</option><option value="pvp">PvP</option><option value="criativo">Criativo</option><option value="minigame">Minigame</option><option value="smp">SMP</option><option value="lojinha">Lojinha</option><option value="outro">Outro</option></select>
                    <select class="inp" id="srvStatF" style="max-width:110px;" onchange="renderSrvs()"><option value="all">Todos</option><option value="online">Online</option><option value="offline">Offline</option></select>
                    <input class="inp" id="srvSearch" placeholder="Pesquisar..." style="max-width:200px;" oninput="renderSrvs()">
                </div>
                <div id="srvsPanel"></div>
            </div>

            <!-- PLAYERS -->
            <div class="page" id="p-players">
                <div class="inp-row">
                    <input class="inp" id="playerSearch" placeholder="Pesquisar jogador..." style="max-width:260px;" oninput="searchPlayers()">
                    <button class="btn" onclick="searchPlayers()"><i class="fas fa-search"></i></button>
                    <label style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text-secondary);"><input type="checkbox" id="playerToxicOnly" onchange="searchPlayers()"> T√≥xicos</label>
                </div>
                <div id="playersPanel"></div>
            </div>

            <!-- INVENTORY -->
            <div class="page" id="p-inventory">
                <div class="inp-row">
                    <select class="inp" id="invBotSelect" style="max-width:260px;" onchange="renderInventory()"><option value="">Selecione um bot</option></select>
                </div>
                <div class="panel"><div class="panel-h"><span>üõ°Ô∏è Armadura</span></div><div class="panel-b" id="invArmor"><div style="color:var(--text-muted);font-size:12px;">Selecione um bot</div></div></div>
                <div class="panel"><div class="panel-h"><span>üì¶ Invent√°rio</span></div><div class="panel-b" id="invItems"><div style="color:var(--text-muted);font-size:12px;">Selecione um bot</div></div></div>
            </div>

            <!-- MESSAGES -->
            <div class="page" id="p-messages">
                <div class="panel"><div class="panel-h"><span>üì£ An√∫ncios</span></div><div class="panel-b"><div class="inp-row"><input class="inp admin-only" id="newMsg" placeholder="Nova mensagem..."><button class="btn primary admin-only" onclick="addMsg()"><i class="fas fa-plus"></i></button></div></div><div class="panel-b np" id="msgsPanel"></div></div>
                <div class="panel"><div class="panel-h"><span>‚öôÔ∏è Config</span></div><div class="panel-b"><div class="inp-row"><label style="font-size:12px;min-width:90px;">Intervalo(s):</label><input type="number" class="inp admin-only" id="intInp" min="10" style="max-width:100px;"><button class="btn primary admin-only" onclick="setInt()">Salvar</button></div><div class="inp-row"><label style="font-size:12px;min-width:90px;">Username:</label><input class="inp admin-only" id="unameInp" style="max-width:180px;"><button class="btn primary admin-only" onclick="setUname()">Salvar</button></div></div></div>
                <div class="panel"><div class="panel-h"><span>üìä Impress√µes</span></div><div class="panel-b" id="impressionsPanel"><div style="color:var(--text-muted);font-size:12px;">Carregando...</div></div></div>
            </div>

            <!-- BLACKLIST -->
            <div class="page" id="p-blacklist">
                <div class="inp-row"><input class="inp admin-only" id="blInp" placeholder="ip:porta" style="max-width:260px;"><button class="btn primary admin-only" onclick="addBl()"><i class="fas fa-plus"></i></button><button class="btn danger admin-only" onclick="cmd('clearBlacklist')"><i class="fas fa-trash"></i> Limpar</button></div>
                <div class="panel"><div class="panel-h"><span>üö´ Permanente</span></div><div class="panel-b np" id="blPerm"></div></div>
                <div class="panel"><div class="panel-h"><span>‚è≥ Tempor√°ria</span></div><div class="panel-b np" id="blTemp"></div></div>
            </div>

            <!-- ANALYTICS -->
            <div class="page" id="p-analytics">
                <div class="inp-row"><button class="btn sm" onclick="loadAn('1h')">1H</button><button class="btn sm primary" onclick="loadAn('24h')">24H</button><button class="btn sm" onclick="loadAn('7d')">7D</button></div>
                <div class="stats-grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));"><div class="stat-card"><div class="si">üí¨</div><div class="sv" id="anMsgs">0</div><div class="sl">Msgs Per√≠odo</div></div></div>
                <div class="panel"><div class="panel-h"><span>üìä Msgs/Hora</span></div><div class="panel-b"><div class="chart-bars" id="anMsgChart" style="height:100px;"></div><div style="height:20px;"></div></div></div>
                <div class="panel"><div class="panel-h"><span>üë• Players</span></div><div class="panel-b"><div class="chart-bars" id="anPlayChart" style="height:100px;"></div><div style="height:20px;"></div></div></div>
                <div class="panel"><div class="panel-h"><span>üèÜ Top Servers</span></div><div class="panel-b np" id="anTopSrv"></div></div>
            </div>

            <!-- VIEWER 3D -->
            <div class="page" id="p-viewer">
                <div class="inp-row">
                    <select class="inp" id="viewerBotSelect" style="max-width:260px;" onchange="loadViewer()"><option value="">Selecione um bot</option></select>
                    <button class="btn primary" onclick="loadViewer()"><i class="fas fa-sync"></i></button>
                </div>
                <div class="panel"><div class="panel-h"><span>üëÅÔ∏è Vis√£o do Bot</span></div><div class="panel-b" id="viewerPanel"><div style="color:var(--text-muted);text-align:center;padding:40px;font-size:12px;">Selecione um bot com viewer ativo</div></div></div>
            </div>

            <!-- TERMINAL -->
            <div class="page" id="p-terminal">
                <div class="sys-grid" id="sysGrid">
                    <div class="sys-card"><div class="sv" id="sysUp">‚Äî</div><div class="sl">Uptime</div></div>
                    <div class="sys-card"><div class="sv" id="sysMem">‚Äî</div><div class="sl">Heap</div></div>
                    <div class="sys-card"><div class="sv" id="sysRss">‚Äî</div><div class="sl">RSS</div></div>
                    <div class="sys-card"><div class="sv" id="sysBots">0</div><div class="sl">Bots</div></div>
                    <div class="sys-card"><div class="sv" id="sysChat">0</div><div class="sl">Chat</div></div>
                    <div class="sys-card"><div class="sv" id="sysSrv">0</div><div class="sl">Servers</div></div>
                    <div class="sys-card"><div class="sv" id="sysNode">‚Äî</div><div class="sl">Node</div></div>
                    <div class="sys-card"><div class="sv" id="sysPlat">‚Äî</div><div class="sl">OS</div></div>
                </div>
                <div class="inp-row"><button class="btn primary" onclick="reqSys()"><i class="fas fa-sync"></i> Info</button><button class="btn danger admin-only" onclick="restartBot()"><i class="fas fa-power-off"></i> Reiniciar</button><button class="btn" onclick="clearTerm()"><i class="fas fa-eraser"></i> Limpar</button></div>
                <div class="panel" style="margin-top:10px;"><div class="panel-h"><span><i class="fas fa-terminal"></i> Console</span><span style="font-size:10px;color:var(--text-muted);" id="termCount">0</span></div><div class="panel-b np"><div class="term-screen" id="termScreen"><div class="term-line"><span class="tv">Aguardando bot...</span></div></div></div></div>
            </div>

            <!-- LOGS -->
            <div class="page" id="p-logs">
                <div class="panel"><div class="panel-h"><span>üìã Logs</span><button class="btn sm" onclick="cmd('refresh')"><i class="fas fa-sync"></i></button></div><div class="panel-b np" id="logsP" style="max-height:calc(100vh - 180px);overflow-y:auto;"></div></div>
            </div>

            <!-- KEYS -->
            <div class="page" id="p-keys">
                <div class="panel"><div class="panel-h"><span>üîë Nova Key</span></div><div class="panel-b">
                    <div class="inp-row"><label style="font-size:12px;min-width:80px;">Label:</label><input class="inp" id="keyLabel" placeholder="Nome do cliente" style="max-width:200px;"></div>
                    <div class="inp-row"><label style="font-size:12px;min-width:80px;">Dura√ß√£o(h):</label><input type="number" class="inp" id="keyDuration" placeholder="24" min="1" style="max-width:100px;"></div>
                    <div class="inp-row"><label style="font-size:12px;min-width:80px;">An√∫ncio:</label><input class="inp" id="keyAdMsg" placeholder="Mensagem do an√∫ncio pago"></div>
                    <button class="btn primary" onclick="createKey()"><i class="fas fa-plus"></i> Criar</button>
                </div></div>
                <div class="panel"><div class="panel-h"><span>üìã Keys</span></div><div class="panel-b np" id="keysPanel"></div></div>
                <div class="panel"><div class="panel-h"><span>üì¢ An√∫ncios Pagos</span></div><div class="panel-b np" id="adsPanel"></div></div>
            </div>

            <!-- SETTINGS -->
            <div class="page" id="p-settings">
                <div class="panel"><div class="panel-h"><span>‚öôÔ∏è Info</span></div><div class="panel-b">
                    <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:12px;border-bottom:1px solid var(--border);"><span>Relay</span><span style="color:var(--accent);" id="setRelay">‚Äî</span></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:12px;border-bottom:1px solid var(--border);"><span>Bot</span><span style="color:var(--accent);" id="setBot">‚Äî</span></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:12px;border-bottom:1px solid var(--border);"><span>Papel</span><span style="color:var(--accent);" id="setRole">‚Äî</span></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;font-size:12px;"><span>Vers√£o</span><span style="color:var(--accent);">9.0</span></div>
                </div></div>
                <div class="panel"><div class="panel-h"><span>üíæ Dados</span></div><div class="panel-b"><div class="inp-row"><button class="btn admin-only" onclick="cmd('saveChat')"><i class="fas fa-save"></i> Salvar</button><button class="btn" onclick="dlChat()"><i class="fas fa-download"></i> Chat</button><button class="btn" onclick="exportLearn()"><i class="fas fa-brain"></i> Learning</button></div></div></div>
            </div>

        </div>
    </div>
</div>
<div class="toast-c" id="toastC"></div>
<script>
// ========== STATE ==========
let socket=null,currentUser=null,currentRole=null,currentPage='dashboard',botOnline=false;
let allBots=[],allServers=[],allChat=[],allLogs=[],stats={},analyticsData={},learningData={},topServerChat={},sessionToken=null;
let inventoryData={},isMobile=window.innerWidth<=768;
const RELAY=window.location.origin;

// ========== MOBILE ==========
function toggleSidebar(){
    const sb=document.getElementById('sidebar');
    const ov=document.getElementById('mobileOverlay');
    sb.classList.toggle('open');
    ov.classList.toggle('show');
}
function closeSidebar(){
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('mobileOverlay').classList.remove('show');
}
window.addEventListener('resize',()=>{isMobile=window.innerWidth<=768;});

// ========== LOGIN ==========
function doLogin(){
    const u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value.trim();
    if(!u)return;
    document.getElementById('loginBtn').disabled=true;
    document.getElementById('loginError').style.display='none';
    if(socket){socket.disconnect();socket=null;}
    socket=io(RELAY,{reconnection:true,reconnectionDelay:2000});
    socket.on('connect',()=>{
        socket.emit('authenticate',{username:u,password:p||u},(r)=>{
            if(r.success){
                currentUser=r.username;currentRole=r.role;sessionToken=r.sessionToken;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').style.display='flex';
                document.getElementById('sbUser').textContent=currentUser;
                const rl=r.role==='admin'?'üëë Admin':r.role==='viewer'?'üëÅÔ∏è Viewer':'üîë Client';
                document.getElementById('sbRole').textContent=rl;
                document.getElementById('sbRole').className='role '+r.role;
                document.getElementById('setRole').textContent=rl;
                document.getElementById('setRelay').textContent=RELAY;
                applyPerms();startKeepAlive();toast('‚úÖ Login!');
                if(r.role==='client'&&r.keyData)showClientInfo(r.keyData);
            }else{
                document.getElementById('loginError').style.display='block';
                document.getElementById('loginError').textContent=r.error||'Erro!';
                document.getElementById('loginBtn').disabled=false;
            }
        });
    });
    socket.on('connect_error',()=>{
        document.getElementById('loginError').style.display='block';
        document.getElementById('loginError').textContent='Erro de conex√£o!';
        document.getElementById('loginBtn').disabled=false;
    });
    socket.on('requireAuth',()=>{});
    socket.on('sessionExpired',()=>{toast('‚è∞ Sess√£o expirou!');doLogout();});
    setupEvents();
}

function doLogout(){
    if(socket){socket.disconnect();socket=null;}
    currentUser=null;currentRole=null;sessionToken=null;
    document.getElementById('loginOverlay').classList.remove('hidden');
    document.getElementById('app').style.display='none';
    document.getElementById('loginBtn').disabled=false;
    document.getElementById('loginUser').value='';
    document.getElementById('loginPass').value='';
}

function applyPerms(){
    if(currentRole==='viewer'||currentRole==='client'){
        document.querySelectorAll('.admin-only').forEach(el=>{el.classList.add('no-perm');el.title='Sem permiss√£o';});
    }else{
        document.querySelectorAll('.admin-only').forEach(el=>{el.classList.remove('no-perm');el.title='';});
    }
}

function startKeepAlive(){
    setInterval(()=>{
        if(socket&&sessionToken)socket.emit('keepAlive',{sessionToken},(r)=>{
            if(r&&!r.valid){toast('‚è∞ Sess√£o expirou!');doLogout();}
        });
    },30000);
}

function showClientInfo(kd){
    const rem=kd.remainingMs||0;
    const h=Math.floor(rem/3600000),m=Math.floor((rem%3600000)/60000);
    toast(`üîë Bem-vindo ${kd.label}! Tempo: ${h}h ${m}m`);
}

// ========== EVENTS ==========
function setupEvents(){
    socket.on('init',(d)=>{
        if(d.stats){stats=d.stats;updateStats();}
        if(d.bots){allBots=d.bots;renderBots();updateBotSelectors();}
        if(d.logs){allLogs=d.logs;renderLogs();}
        if(d.chatDatabase){allChat=d.chatDatabase;renderChat();updateChatFilters();}
        if(d.servers){allServers=d.servers;renderSrvs();}
        if(d.topServerChat){topServerChat=d.topServerChat;renderTSC();}
    });
    socket.on('botStatus',(on)=>{
        botOnline=on;
        document.getElementById('botDot').className='status-dot '+(on?'online':'offline');
        document.getElementById('botText').textContent=on?'Online':'Offline';
        document.getElementById('setBot').textContent=on?'üü¢ Online':'üî¥ Offline';
    });
    socket.on('statsUpdate',(d)=>{stats=d;updateStats();});
    socket.on('botsUpdate',(d)=>{
        allBots=d||[];renderBots();updateBotSelectors();
        document.getElementById('botsCount').textContent=allBots.filter(b=>b.conectado).length;
    });
    socket.on('serverUpdate',(d)=>{
        if(Array.isArray(d))allServers=d;
        else if(d?.key){const i=allServers.findIndex(s=>s.key===d.key);if(i>=0)allServers[i]={...allServers[i],...d};else allServers.push(d);}
        renderSrvs();updateChatFilters();
    });
    socket.on('chatMessage',(m)=>{
        // Anti-duplica√ß√£o client-side
        const hash=`${m.timestamp}-${m.serverKey}-${m.username}`;
        if(allChat.some(c=>`${c.timestamp}-${c.serverKey}-${c.username}`===hash))return;
        allChat.push(m);if(allChat.length>5000)allChat.shift();
        appendChat(m);updateChatFilters();
    });
    socket.on('chatMessages',(m)=>{allChat=m||[];renderChat();});
    socket.on('log',(e)=>{allLogs.push(e);if(allLogs.length>200)allLogs.shift();appendLog(e);});
    socket.on('topServerChat',(d)=>{topServerChat=d;renderTSC();});
    socket.on('learningData',(d)=>{learningData=d;renderLearn();});
    socket.on('learningExport',(d)=>{dlJSON(d,'learning-db.json');});
    socket.on('analyticsData',(d)=>{renderAnalytics(d);});
    socket.on('fullChat',(d)=>{dlJSON({exportado:new Date().toISOString(),total:d.length,msgs:d},'chat.json');});
    socket.on('chatDownload',(d)=>{dlJSON(d,'chat.json');});
    socket.on('playersDBData',(d)=>{renderPlayersResult(d);});
    socket.on('botSystemInfo',(d)=>{updateSysInfo(d);});
    socket.on('botConsoleLog',(e)=>{appendTerm(e);});
    socket.on('inventoryUpdate',(d)=>{inventoryData[d.serverKey]=d.inventory;if(currentPage==='inventory')renderInventory();});
    socket.on('toast',(m)=>toast(m));
    socket.on('systemAlert',(a)=>{toast(`üö® ${a.message}`);});
    socket.on('impressionsData',(d)=>{renderImpressions(d);});
    socket.on('disconnect',()=>{
        document.getElementById('botDot').className='status-dot offline';
        document.getElementById('botText').textContent='Desconectado';
    });
    socket.on('reconnect',()=>{
        if(sessionToken)socket.emit('keepAlive',{sessionToken},(r)=>{
            if(!r?.valid)doLogout();else toast('üîÑ Reconectado!');
        });
    });
}

// ========== NAV ==========
function nav(p){
    currentPage=p;
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
    document.getElementById('p-'+p)?.classList.add('active');
    document.querySelector(`.nav-item[data-page="${p}"]`)?.classList.add('active');
    const t={dashboard:'Dashboard',bots:'Bots',chat:'Chat',learning:'Aprendizado',servers:'Servidores',players:'Players',inventory:'Invent√°rio',messages:'Mensagens',blacklist:'Blacklist',analytics:'Analytics',viewer:'Viewer 3D',terminal:'Terminal',logs:'Logs',keys:'Keys/Ads',settings:'Config'};
    document.getElementById('pageTitle').textContent=t[p]||p;
    if(p==='analytics')loadAn('24h');
    if(p==='learning')reqLearn();
    if(p==='chat')filterChat();
    if(p==='terminal')reqSys();
    if(p==='keys')loadKeys();
    if(p==='players')searchPlayers();
    if(p==='messages'&&socket)socket.emit('getImpressions');
    if(p==='inventory')updateBotSelectors();
    if(p==='viewer')updateBotSelectors();
    if(isMobile)closeSidebar();
}

// ========== STATS ==========
function updateStats(){
    document.getElementById('sBots').textContent=stats.botsAtivos||0;
    document.getElementById('sMsgs').textContent=allChat.length;
    document.getElementById('sBl').textContent=stats.blacklistSize||0;
    document.getElementById('sImpressions').textContent=stats.impressions?.total||0;
    const on=allServers.filter(s=>s.status==='online');
    document.getElementById('sServers').textContent=on.length;
    let tp=0;allServers.forEach(s=>{if(s.players&&Array.isArray(s.players))tp+=s.players.length;});
    document.getElementById('sPlayers').textContent=tp;
    if(stats.intervalo)document.getElementById('intInp').value=stats.intervalo;
    if(stats.username)document.getElementById('unameInp').value=stats.username;
    renderMsgs();renderBl();renderTopSrv();renderPeakMini();
}

// ========== BOTS ==========
function renderBots(){
    const bp=document.getElementById('botsPanel'),fp=document.getElementById('botsFull');
    const bl=allBots.filter(b=>b.conectado);
    const empty='<div style="padding:16px;color:var(--text-muted);text-align:center;font-size:12px;">Nenhum bot</div>';
    if(!bl.length){bp.innerHTML=empty;fp.innerHTML=empty;return;}
    const rc=b=>{
        const isA=currentRole==='admin';
        const pt=b.protocolType&&b.protocolType!=='vanilla'?` [${b.protocolType}]`:'';
        const tps=b.tps?` TPS:${b.tps}`:'';
        return`<div class="bot-card"><div class="bot-dot on"></div><div class="bot-info"><div class="bot-name">${esc(b.username||'?')}${pt}</div><div class="bot-srv">${esc(b.key)} (v${b.versao||'?'})${tps}</div>${b.motd?`<div class="bot-motd">${esc(b.motd)}</div>`:''}</div><div class="bot-mini">${b.hp!=null?`<span>‚ù§${Math.round(b.hp)}</span>`:''} ${b.food!=null?`<span>üçñ${Math.round(b.food)}</span>`:''} ${b.players?`<span>üë•${b.players.length}</span>`:''}</div><div class="bot-actions">${isA?`<button class="btn sm" onclick="cmd('jump','${b.key}')"><i class="fas fa-arrow-up"></i></button><button class="btn sm danger" onclick="cmd('disconnect_server','${b.key}')"><i class="fas fa-power-off"></i></button>`:''}</div></div>`;
    };
    bp.innerHTML=bl.slice(0,5).map(rc).join('');
    fp.innerHTML=bl.map(rc).join('');
}

function updateBotSelectors(){
    const bl=allBots.filter(b=>b.conectado);
    // Inventory selector
    const invSel=document.getElementById('invBotSelect');
    if(invSel){
        const cv=invSel.value;
        invSel.innerHTML='<option value="">Selecione um bot</option>'+bl.map(b=>`<option value="${esc(b.key)}">${esc(b.key)} (${esc(b.username||'?')})</option>`).join('');
        if(cv)invSel.value=cv;
    }
    // Viewer selector
    const vSel=document.getElementById('viewerBotSelect');
    if(vSel){
        const cv=vSel.value;
        const withViewer=bl.filter(b=>b.viewerPort);
        vSel.innerHTML='<option value="">Selecione um bot</option>'+withViewer.map(b=>`<option value="${b.viewerPort}">${esc(b.key)} (porta ${b.viewerPort})</option>`).join('');
        if(cv)vSel.value=cv;
    }
    // Chat send selector
    updateChatFilters();
}

// ========== CHAT ==========
function renderChat(){
    const c=document.getElementById('chatMsgs');
    const msgs=getFiltered().slice(-500);
    c.innerHTML=msgs.map(fmtChat).join('');
    c.scrollTop=c.scrollHeight;
}

function appendChat(m){
    const c=document.getElementById('chatMsgs');
    const f=document.getElementById('chatFilter').value;
    const s=document.getElementById('chatSearch').value.toLowerCase();
    const st=document.getElementById('chatSType').value;
    if(f!=='all'&&m.serverKey!==f)return;
    if(s){
        if(st==='player'&&!(m.username||'').toLowerCase().includes(s))return;
        if(st==='message'&&!(m.message||'').toLowerCase().includes(s))return;
        if(st==='positive'&&m.sentiment!=='positive')return;
        if(st==='negative'&&m.sentiment!=='negative')return;
        if(st==='all'&&!(m.username||'').toLowerCase().includes(s)&&!(m.message||'').toLowerCase().includes(s))return;
    }else{
        if(st==='positive'&&m.sentiment!=='positive')return;
        if(st==='negative'&&m.sentiment!=='negative')return;
    }
    const atBot=c.scrollTop+c.clientHeight>=c.scrollHeight-40;
    c.insertAdjacentHTML('beforeend',fmtChat(m));
    while(c.children.length>500)c.removeChild(c.firstChild);
    if(atBot)c.scrollTop=c.scrollHeight;
}

function fmtChat(m){
    const bn=(stats.username||'Anunciador').toLowerCase();
    const men=m.botMentioned;
    const isBot=m.isBotMessage;
    const srv=allServers.find(s=>s.key===m.serverKey);
    const motd=m.motd||(srv?cleanMotd(srv.motd):'');
    const sentDot=m.sentiment==='positive'?'<span class="sentiment-dot positive"></span>':m.sentiment==='negative'?'<span class="sentiment-dot negative"></span>':'';
    const countryFlag=m.country?` <span style="font-size:9px;">${m.country==='BR'?'üáßüá∑':m.country==='US'?'üá∫üá∏':m.country==='RU'?'üá∑üá∫':m.country==='ES'?'üá™üá∏':''}</span>`:'';
    const userClass=isBot?'cu bot-user':'cu';
    return`<div class="chat-msg${men?' mentioned':''}">${sentDot}<span class="ct">${m.time||''}</span> <span class="cs" onclick="filterBySrv('${esc(m.serverKey)}')">[${esc(m.serverKey)}${motd?' <span class="cm">'+esc(motd)+'</span>':''}]</span> <span class="${userClass}">${esc(m.username||'?')}${countryFlag}</span>: <span class="cx">${esc(m.message||'')}</span></div>`;
}

function filterBySrv(k){document.getElementById('chatFilter').value=k;filterChat();}

function filterChat(){
    if(!socket)return;
    const sk=document.getElementById('chatFilter').value;
    const s=document.getElementById('chatSearch').value;
    const st=document.getElementById('chatSType').value;
    // Sentiment filter
    let searchVal=s;
    let searchType=st;
    if(st==='positive'||st==='negative'){searchType='sentiment';searchVal=st;}
    socket.emit('getChatMessages',{serverKey:sk,search:searchVal,searchType:searchType});
}

function getFiltered(){
    const f=document.getElementById('chatFilter')?.value||'all';
    const s=(document.getElementById('chatSearch')?.value||'').toLowerCase();
    const st=document.getElementById('chatSType')?.value||'all';
    let m=allChat;
    if(f!=='all')m=m.filter(x=>x.serverKey===f);
    if(st==='positive')m=m.filter(x=>x.sentiment==='positive');
    else if(st==='negative')m=m.filter(x=>x.sentiment==='negative');
    if(s){
        m=m.filter(x=>{
            if(st==='player')return(x.username||'').toLowerCase().includes(s);
            if(st==='message')return(x.message||'').toLowerCase().includes(s);
            return(x.username||'').toLowerCase().includes(s)||(x.message||'').toLowerCase().includes(s);
        });
    }
    return m;
}

function updateChatFilters(){
    const sel=document.getElementById('chatFilter');
    const send=document.getElementById('chatSendSrv');
    const curFilter=sel.value;
    const curSend=send.value;
    const keys=[...new Set([...allChat.map(m=>m.serverKey),...allBots.filter(b=>b.conectado).map(b=>b.key)].filter(Boolean))];
    let o='<option value="all">Todos</option>';
    keys.forEach(k=>{const srv=allServers.find(s=>s.key===k);const motd=srv?cleanMotd(srv.motd):'';o+=`<option value="${esc(k)}">${esc(motd?k+' ‚Äî '+motd:k)}</option>`;});
    sel.innerHTML=o;
    sel.value=curFilter||'all';
    let so='<option value="all">Todos</option>';
    allBots.filter(b=>b.conectado).forEach(b=>{so+=`<option value="${esc(b.key)}">${esc(b.key)}</option>`;});
    send.innerHTML=so;
    send.value=curSend||'all';
}

function sendChat(){if(currentRole!=='admin')return;const m=document.getElementById('chatSendMsg').value.trim(),s=document.getElementById('chatSendSrv').value;if(!m)return;socket.emit('chat',{serverKey:s,message:m});document.getElementById('chatSendMsg').value='';}
function sendCmd(){if(currentRole!=='admin')return;const c=document.getElementById('chatSendCmd').value.trim(),s=document.getElementById('chatSendSrv').value;if(!c)return;socket.emit('command',{serverKey:s,command:c});document.getElementById('chatSendCmd').value='';}

// ========== SERVERS ==========
function renderSrvs(){
    const p=document.getElementById('srvsPanel');
    const cf=document.getElementById('srvCatF')?.value||'all',sf=document.getElementById('srvStatF')?.value||'all',q=(document.getElementById('srvSearch')?.value||'').toLowerCase();
    let srvs=allServers;
    if(cf!=='all')srvs=srvs.filter(s=>(s.categoria||'desconhecido')===cf);
    if(sf!=='all')srvs=srvs.filter(s=>s.status===sf);
    if(q)srvs=srvs.filter(s=>s.key.toLowerCase().includes(q)||(cleanMotd(s.motd)||'').toLowerCase().includes(q));
    srvs.sort((a,b)=>{if(a.status==='online'&&b.status!=='online')return-1;if(b.status==='online'&&a.status!=='online')return 1;return(b.players?.length||0)-(a.players?.length||0);});
    if(!srvs.length){p.innerHTML='<div style="padding:24px;text-align:center;color:var(--text-muted);">Nenhum</div>';return;}
    p.innerHTML=srvs.map(s=>{
        const motd=cleanMotd(s.motd),cat=s.categoria||'desconhecido',rep=s.reputation||50;
        const sc=s.status==='online'?'var(--success)':s.status==='banned'?'var(--danger)':'var(--text-muted)';
        const rc=rep>70?'var(--success)':rep>40?'var(--warning)':'var(--danger)';
        const pc=s.players?.length||s.onlinePlayers||0;
        const isA=currentRole==='admin';
        const plugins=(s.plugins||[]).slice(0,8).join(', ');
        const sw=s.serverSoftware?` [${s.serverSoftware}]`:'';
        const country=s.country?` ${s.country==='BR'?'üáßüá∑':s.country==='US'?'üá∫üá∏':s.country}`:'';
        return`<div class="srv-card"><div class="srv-head"><div><span class="srv-name" style="color:${sc}">‚óè ${esc(s.key)}${sw}${country}</span> <span class="srv-tag ${cat}">${cat}</span>${(s.tags||[]).map(t=>`<span class="srv-tag">${esc(t)}</span>`).join('')}</div><div style="display:flex;gap:3px;align-items:center;">${isA?`<button class="btn sm" onclick="addTag('${esc(s.key)}')"><i class="fas fa-tag"></i></button><button class="btn sm" onclick="setCat('${esc(s.key)}')"><i class="fas fa-folder"></i></button><button class="btn sm" onclick="scanSrv('${esc(s.key)}')"><i class="fas fa-search"></i></button><button class="btn sm ${(stats.silentServers||[]).includes(s.key)?'danger':''}\" onclick="toggleSilent('${esc(s.key)}')"><i class="fas fa-volume-${(stats.silentServers||[]).includes(s.key)?'mute':'up'}"></i></button>`:''}<span style="font-size:10px;color:var(--text-muted);">üë•${pc}/${s.maxPlayers||'?'}</span></div></div>${motd?`<div class="srv-motd">"${esc(motd)}"</div>`:''}<div class="srv-meta"><span>üì°${s.version||'?'}</span><span>üìä${s.status}</span>${s.ping?`<span>üèì${s.ping}ms</span>`:''}<span>‚≠ê${rep}</span>${s.peakPlayers?`<span>üîù${s.peakPlayers}</span>`:''}</div>${plugins?`<div class="srv-plugins">üîå ${esc(plugins)}${(s.plugins||[]).length>8?'...':''}</div>`:''}<div class="rep-bar"><div class="fill" style="width:${rep}%;background:${rc}"></div></div></div>`;
    }).join('');
}

function toggleSilent(k){socket.emit('setSilentServer',{serverKey:k,silent:!(stats.silentServers||[]).includes(k)});}

// ========== PLAYERS ==========
function searchPlayers(){
    const q=document.getElementById('playerSearch').value.trim();
    const toxic=document.getElementById('playerToxicOnly').checked;
    socket.emit('getPlayersDB',{search:q,toxic:toxic||undefined});
}

function renderPlayersResult(players){
    const p=document.getElementById('playersPanel');
    if(!players||!players.length){p.innerHTML='<div style="padding:24px;text-align:center;color:var(--text-muted);">Nenhum</div>';return;}
    p.innerHTML=players.map(pl=>{
        const roles=(pl.roles||[]).map(r=>`<span class="player-role">${r}</span>`).join(' ');
        const peak=pl.peakHour||'?';
        const lastDate=pl.lastSeen?new Date(pl.lastSeen).toLocaleString('pt-BR'):'?';
        const sentTotal=(pl.sentiment?.positive||0)+(pl.sentiment?.negative||0)+(pl.sentiment?.neutral||0);
        const sentPct=sentTotal>0?Math.round((pl.sentiment.positive/sentTotal)*100):50;
        const country=pl.dominantCountry?` ${pl.dominantCountry==='BR'?'üáßüá∑':pl.dominantCountry}`:'';
        const cross=pl.crossServer?'<span style="color:var(--accent);font-size:9px;font-weight:600;"> CROSS-SERVER</span>':'';
        const influential=pl.isInfluential?'<span style="color:var(--warning);font-size:9px;font-weight:600;"> ‚≠ê INFLUENTE</span>':'';
        return`<div class="player-card"><div class="player-head"><img class="player-avatar" src="https://mc-heads.net/avatar/${esc(pl.username)}/32" onerror="this.src='https://mc-heads.net/avatar/Steve/32'"><div><div class="player-name">${esc(pl.username)}${country} ${roles} ${pl.toxic?'<span class="player-toxic">‚ò† T√ìXICO</span>':''}${cross}${influential}</div><div style="font-size:10px;color:var(--text-muted);">Visto: ${lastDate}</div></div></div><div class="player-stats"><span>üí¨ ${pl.messageCount||0}</span><span>üñ•Ô∏è ${(pl.servers||[]).length} srv</span><span>‚è∞ ${peak}h</span><span>üòä ${sentPct}%</span></div>${pl.messages&&pl.messages.length>0?`<div style="margin-top:6px;font-size:11px;color:var(--text-secondary);">${pl.messages.slice(-3).map(m=>`<div style="padding:1px 0;"><span style="color:var(--text-muted);">[${esc(m.server||'')}]</span> ${esc(m.text||'')}</div>`).join('')}</div>`:''}</div>`;
    }).join('');
}

// ========== INVENTORY ==========
function renderInventory(){
    const sel=document.getElementById('invBotSelect');
    const key=sel.value;
    const armorP=document.getElementById('invArmor');
    const itemsP=document.getElementById('invItems');
    if(!key){armorP.innerHTML='<div style="color:var(--text-muted);font-size:12px;">Selecione um bot</div>';itemsP.innerHTML=armorP.innerHTML;return;}
    const bot=allBots.find(b=>b.key===key);
    const inv=bot?.inventory||inventoryData[key];
    if(!inv){armorP.innerHTML='<div style="color:var(--text-muted);font-size:12px;">Sem dados</div>';itemsP.innerHTML=armorP.innerHTML;return;}
    armorP.innerHTML=(inv.armor||[]).length?`<div class="inv-grid">${inv.armor.map(a=>`<div class="inv-slot armor"><div class="inv-name">${esc(a.displayName||a.name)}</div></div>`).join('')}</div>`:'<div style="color:var(--text-muted);font-size:12px;">Sem armadura</div>';
    itemsP.innerHTML=(inv.items||[]).length?`<div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;">${inv.usedSlots||0}/${inv.totalSlots||36} slots</div><div class="inv-grid">${inv.items.map(i=>`<div class="inv-slot"><div class="inv-name">${esc(i.displayName||i.name)}</div><div class="inv-count">x${i.count}</div></div>`).join('')}</div>`:'<div style="color:var(--text-muted);font-size:12px;">Vazio</div>';
}

// ========== VIEWER ==========
function loadViewer(){
    const sel=document.getElementById('viewerBotSelect');
    const port=sel.value;
    const panel=document.getElementById('viewerPanel');
    if(!port){panel.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:40px;font-size:12px;">Selecione um bot</div>';return;}
    panel.innerHTML=`<iframe class="viewer-frame" src="http://localhost:${port}" frameborder="0" allowfullscreen></iframe><div style="font-size:10px;color:var(--text-muted);margin-top:6px;">Porta: ${port} | Use mouse pra rotacionar</div>`;
}

// ========== IMPRESSIONS ==========
function renderImpressions(data){
    const p=document.getElementById('impressionsPanel');
    if(!data||!data.total){p.innerHTML='<div style="color:var(--text-muted);font-size:12px;">Sem dados</div>';return;}
    let h=`<div style="font-size:12px;margin-bottom:8px;">Total: <strong>${data.total}</strong></div>`;
    if(data.byMessage){
        h+='<div style="font-size:11px;font-weight:600;margin-bottom:4px;">Por Mensagem:</div>';
        Object.entries(data.byMessage).forEach(([k,v])=>{
            h+=`<div style="font-size:11px;padding:2px 0;color:var(--text-secondary);">${esc(k)}: ${v.count}x em ${v.servers.length} servers</div>`;
        });
    }
    p.innerHTML=h;
}

// ========== TOP SERVER ==========
function renderTopSrv(){
    const p=document.getElementById('topSrvPanel');
    const ss={};allChat.forEach(m=>{if(!m.serverKey)return;if(!ss[m.serverKey])ss[m.serverKey]={msgs:0,pl:new Set()};ss[m.serverKey].msgs++;if(m.username)ss[m.serverKey].pl.add(m.username);});
    const top=Object.entries(ss).map(([k,d])=>({key:k,msgs:d.msgs,pl:d.pl.size})).sort((a,b)=>b.msgs-a.msgs).slice(0,3);
    if(!top.length){p.innerHTML='<div style="padding:16px;color:var(--text-muted);text-align:center;font-size:12px;">Aguardando...</div>';return;}
    const medals=['ü•á','ü•à','ü•â'];
    p.innerHTML=top.map((s,i)=>{const srv=allServers.find(x=>x.key===s.key);const motd=srv?cleanMotd(srv.motd):'';return`<div class="bot-card"><div style="font-size:18px;">${medals[i]}</div><div class="bot-info"><div class="bot-name">${esc(s.key)}</div>${motd?`<div class="bot-motd">${esc(motd)}</div>`:''}</div><div class="bot-mini"><span>üí¨${s.msgs}</span><span>üë•${s.pl}</span></div></div>`;}).join('');
}

function renderTSC(){
    const p=document.getElementById('tscPanel');
    if(!topServerChat.serverKey){p.innerHTML='<div style="padding:16px;color:var(--text-muted);text-align:center;font-size:12px;">Nenhum</div>';return;}
    let h=`<div class="tsc-h"><strong>${esc(topServerChat.serverKey)}</strong>${topServerChat.motd?' ‚Äî <em>'+esc(topServerChat.motd)+'</em>':''}<span style="float:right;">üë•${topServerChat.players||0}</span></div>`;
    (topServerChat.messages||[]).slice(-25).forEach(m=>{h+=`<div class="tsc-m"><span style="color:var(--text-muted);font-size:9px;">${m.time||''}</span> <span style="color:var(--success);font-weight:600;">${esc(m.username||'?')}</span>: ${esc(m.message||'')}</div>`;});
    p.innerHTML=h;p.scrollTop=p.scrollHeight;
}

function renderPeakMini(){
    const c=document.getElementById('peakChart');
    const hrs={};allChat.forEach(m=>{if(!m.timestamp)return;const h=new Date(m.timestamp).getHours();hrs[h]=(hrs[h]||0)+1;});
    const data=[];for(let i=0;i<24;i++)data.push({hour:i,count:hrs[i]||0});
    renderBars(c,data,'hour','count',h=>h+'h');
}

// ========== LOGS ==========
function renderLogs(){
    const p=document.getElementById('logsP'),dp=document.getElementById('dashLogs');
    const h=allLogs.slice(-100).reverse().map(l=>`<div class="log-e"><span class="log-t">[${l.time||''}]</span> ${l.emoji||''} ${esc(l.msg||'')}</div>`).join('');
    p.innerHTML=h;
    dp.innerHTML=allLogs.slice(-10).reverse().map(l=>`<div class="log-e"><span class="log-t">[${l.time||''}]</span> ${l.emoji||''} ${esc(l.msg||'')}</div>`).join('');
}
function appendLog(e){
    const p=document.getElementById('logsP'),dp=document.getElementById('dashLogs');
    const h=`<div class="log-e"><span class="log-t">[${e.time||''}]</span> ${e.emoji||''} ${esc(e.msg||'')}</div>`;
    p.insertAdjacentHTML('afterbegin',h);while(p.children.length>100)p.removeChild(p.lastChild);
    dp.insertAdjacentHTML('afterbegin',h);while(dp.children.length>10)dp.removeChild(dp.lastChild);
}

// ========== MESSAGES ==========
function renderMsgs(){
    const p=document.getElementById('msgsPanel');
    const msgs=stats.mensagens||[];
    if(!msgs.length){p.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:12px;">Nenhuma</div>';return;}
    const isA=currentRole==='admin';
    p.innerHTML=msgs.map((m,i)=>`<div class="msg-item"><span class="msg-idx">#${i+1}</span><span class="msg-txt">${esc(m)}</span>${isA?`<button class="btn sm danger" onclick="delMsg(${i})"><i class="fas fa-trash"></i></button>`:''}</div>`).join('');
}

// ========== BLACKLIST ==========
function renderBl(){
    const pp=document.getElementById('blPerm'),tp=document.getElementById('blTemp');
    const items=stats.blacklistItems||[],temp=stats.tempBlacklistItems||[];
    const isA=currentRole==='admin';
    pp.innerHTML=items.length?items.map(k=>`<div class="bl-item"><span class="bl-type perm">Perm</span><span style="flex:1;">${esc(k)}</span>${isA?`<button class="btn sm" onclick="cmd('removeBlacklist','${esc(k)}')"><i class="fas fa-times"></i></button>`:''}</div>`).join(''):'<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Vazio</div>';
    tp.innerHTML=temp.length?temp.map(t=>`<div class="bl-item"><span class="bl-type temp">‚è≥${t.remainingMin||'?'}m</span><span style="flex:1;">${esc(t.key)}</span><span style="font-size:10px;color:var(--text-muted);">${esc(t.reason||'')}</span>${isA?`<button class="btn sm" onclick="cmd('removeBlacklist','${esc(t.key)}')"><i class="fas fa-times"></i></button>`:''}</div>`).join(''):'<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Vazio</div>';
}

// ========== LEARNING ==========
function renderLearn(){
    if(!learningData?.totalMensagens)return;
    document.getElementById('lTotal').textContent=learningData.totalMensagens||0;
    document.getElementById('lMin').textContent=(learningData.padroes?.percentMinuscula||0)+'%';
    document.getElementById('lAcento').textContent=(learningData.padroes?.percentAcento||0)+'%';
    document.getElementById('lAbrev').textContent=(learningData.padroes?.percentAbreviacao||0)+'%';
    const isA=currentRole==='admin';
    document.getElementById('giriasC').innerHTML=(learningData.topGirias||[]).map(([w,c])=>`<span class="word-tag">${esc(w)} <span class="cnt">(${c})</span>${isA?`<span class="word-del" onclick="removeLearnItem('giria','${esc(w)}')" title="Remover">√ó</span>`:''}</span>`).join('');
    document.getElementById('exprC').innerHTML=(learningData.topExpressoes||[]).map(e=>`<span class="word-tag">${esc(e.texto)} <span class="cnt">(${e.count})</span>${isA?`<span class="word-del" onclick="removeLearnItem('expressao','${esc(e.texto)}')" title="Remover">√ó</span>`:''}</span>`).join('');
    const fp=document.getElementById('frasesP');
    const fr=learningData.topFrases||[];
    fp.innerHTML=fr.length?fr.map(f=>`<div class="msg-item"><span class="msg-txt">"${esc(f.texto)}"</span><span style="font-size:10px;color:var(--text-muted);">√ó${f.count}</span>${isA?`<button class="btn sm danger" onclick="removeLearnItem('frase','${esc(f.texto)}')"><i class="fas fa-trash"></i></button>`:''}</div>`).join(''):'<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Nenhuma</div>';
}
function reqLearn(){if(socket)socket.emit('getLearningData');}
function exportLearn(){if(socket)socket.emit('exportLearningDB');}
function removeLearnItem(type,value){if(currentRole!=='admin')return;if(!confirm(`Remover "${value}"?`))return;socket.emit('removeLearnItem',{type,value});toast(`üóëÔ∏è Removido`);setTimeout(reqLearn,1000);}

// ========== ANALYTICS ==========
function loadAn(p){if(socket)socket.emit('getAnalytics',p);}
function renderAnalytics(d){
    document.getElementById('anMsgs').textContent=d.totalMessages||0;
    const md=[];for(let i=0;i<24;i++){const e=(d.messagesPerHour||[]).find(x=>x.hour===i);md.push({hour:i,count:e?e.count:0});}
    renderBars(document.getElementById('anMsgChart'),md,'hour','count',h=>h+'h');
    const pd=(d.playersOverTime||[]).slice(-48);
    if(pd.length>0){const s=[];const step=Math.max(1,Math.floor(pd.length/24));for(let i=0;i<pd.length;i+=step){const dt=new Date(pd[i].timestamp);s.push({label:dt.getHours()+':'+String(dt.getMinutes()).padStart(2,'0'),count:pd[i].total});}renderBars(document.getElementById('anPlayChart'),s,'label','count');}
    const tp=document.getElementById('anTopSrv');
    const top=d.topServers||[];
    tp.innerHTML=top.length?top.map((s,i)=>`<div class="bot-card"><div style="min-width:20px;font-weight:700;color:var(--accent);">#${i+1}</div><div class="bot-info"><div class="bot-name">${esc(s.serverKey)}</div></div><div class="bot-mini"><span>üí¨${s.messages}</span><span>üë•${s.uniquePlayers}</span></div></div>`).join(''):'<div style="padding:12px;text-align:center;color:var(--text-muted);font-size:12px;">Sem dados</div>';
}

// ========== CHART ==========
function renderBars(c,data,lk,vk,fmt){
    if(!data||!data.length){c.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:11px;">Sem dados</div>';return;}
    const mx=Math.max(...data.map(d=>d[vk]||0),1);
    c.innerHTML=data.map(d=>{const v=d[vk]||0;const h=Math.max(2,(v/mx)*100);const l=fmt?fmt(d[lk]):d[lk];return`<div class="chart-bar" style="height:${h}%" title="${l}: ${v}">${v>0?`<div class="bv">${v}</div>`:''}<div class="bl">${l}</div></div>`;}).join('');
}

// ========== TERMINAL ==========
function updateSysInfo(d){
    if(d.uptime)document.getElementById('sysUp').textContent=d.uptime;
    if(d.memory){if(d.memory.heapUsed)document.getElementById('sysMem').textContent=d.memory.heapUsed+'MB';if(d.memory.rss)document.getElementById('sysRss').textContent=d.memory.rss+'MB';}
    if(d.botsAtivos!==undefined)document.getElementById('sysBots').textContent=d.botsAtivos;
    if(d.chatMessages!==undefined)document.getElementById('sysChat').textContent=d.chatMessages;
    if(d.servidores!==undefined)document.getElementById('sysSrv').textContent=d.servidores;
    if(d.nodeVersion)document.getElementById('sysNode').textContent=d.nodeVersion;
    if(d.platform)document.getElementById('sysPlat').textContent=d.platform;
    if(d.memory?.heapUsed)document.getElementById('memText').textContent=d.memory.heapUsed+'MB';
    if(d.uptime)document.getElementById('uptime').textContent=d.uptime;
}
function appendTerm(e){
    const s=document.getElementById('termScreen');if(!s)return;
    const t=e.text||'';let cls='';if(t.includes('‚ùå')||t.includes('FATAL'))cls=' err';else if(t.includes('‚úÖ'))cls=' ok';else if(t.includes('‚ö†'))cls=' warn';
    const l=document.createElement('div');l.className='term-line'+cls;l.innerHTML=`<span class="tt">[${esc(e.time||'')}]</span> <span class="tv">${esc(t)}</span>`;
    s.appendChild(l);while(s.children.length>800)s.removeChild(s.firstChild);
    s.scrollTop=s.scrollHeight;
    document.getElementById('termCount').textContent=s.children.length;
}
function clearTerm(){document.getElementById('termScreen').innerHTML='<div class="term-line"><span class="tv">Limpo.</span></div>';}
function reqSys(){if(socket)socket.emit('getBotSystemInfo');}
function restartBot(){if(currentRole!=='admin')return;if(!confirm('‚ö†Ô∏è Reiniciar bot?'))return;socket.emit('restartBotProcess');}

// ========== KEYS ==========
function loadKeys(){
    if(!socket||currentRole!=='admin')return;
    socket.emit('getKeys',(keys)=>{renderKeys(keys);});
    socket.emit('getAds',(ads)=>{renderAds(ads);});
}
function createKey(){
    const label=document.getElementById('keyLabel').value.trim();
    const dur=parseInt(document.getElementById('keyDuration').value)||24;
    const msg=document.getElementById('keyAdMsg').value.trim();
    if(!label){toast('‚ö†Ô∏è Label!');return;}
    socket.emit('createKey',{label,durationHours:dur,adMessage:msg},(r)=>{
        if(r.success){toast(`‚úÖ Key: ${r.key}`);document.getElementById('keyLabel').value='';document.getElementById('keyDuration').value='';document.getElementById('keyAdMsg').value='';loadKeys();}
        else toast('‚ùå Erro');
    });
}
function renderKeys(keys){
    const p=document.getElementById('keysPanel');
    if(!keys||!keys.length){p.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:12px;">Nenhuma</div>';return;}
    p.innerHTML=keys.map(k=>{
        const exp=k.expiresAt?new Date(k.expiresAt).toLocaleString('pt-BR'):'‚àû';
        return`<div class="key-card"><div style="display:flex;justify-content:space-between;align-items:center;"><strong>${esc(k.label||'?')}</strong><span style="font-size:10px;color:${k.active?'var(--success)':'var(--danger)'};">${k.active?'‚úÖ':'‚ùå'}</span></div><div class="key-value">${esc(k.fullKey||k.key)}</div><div class="key-meta"><span>üìÖ ${new Date(k.createdAt).toLocaleDateString('pt-BR')}</span><span>‚è∞ ${exp}</span><span>üë§ ${esc(k.createdBy||'?')}</span></div><div style="margin-top:8px;display:flex;gap:4px;flex-wrap:wrap;">${k.active?`<button class="btn sm danger" onclick="revokeKey('${k.id}')">Revogar</button>`:''}<button class="btn sm" onclick="deleteKey('${k.id}')">Deletar</button><button class="btn sm" onclick="copyKey('${esc(k.fullKey||k.key)}')">Copiar</button></div></div>`;
    }).join('');
}
function renderAds(ads){
    const p=document.getElementById('adsPanel');
    if(!ads||!ads.length){p.innerHTML='<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:12px;">Nenhum</div>';document.getElementById('sAds').textContent='0';return;}
    const active=ads.filter(a=>a.status==='active');
    document.getElementById('sAds').textContent=active.length;
    p.innerHTML=ads.map(a=>{
        const pct=a.totalMs>0?Math.max(0,Math.min(100,(a.remainingMs/a.totalMs)*100)):0;
        const rem=a.remainingMs>0?`${Math.floor(a.remainingMs/3600000)}h ${Math.floor((a.remainingMs%3600000)/60000)}m`:'Expirado';
        const sc=a.status==='active'?'var(--success)':'var(--danger)';
        return`<div class="ad-card"><div style="display:flex;justify-content:space-between;"><strong style="font-size:12px;">${esc(a.label||'?')}</strong><span style="font-size:10px;color:${sc};">${a.status}</span></div><div style="font-size:11px;color:var(--text-secondary);margin:4px 0;">"${esc(a.message||'')}"</div><div style="font-size:10px;color:var(--text-muted);">‚è≥ ${rem}</div><div class="ad-progress"><div class="fill" style="width:${pct}%"></div></div></div>`;
    }).join('');
}
function revokeKey(id){if(confirm('Revogar?'))socket.emit('revokeKey',id,(r)=>{if(r.success){toast('‚úÖ');loadKeys();}});}
function deleteKey(id){if(confirm('Deletar?'))socket.emit('deleteKey',id,(r)=>{if(r.success){toast('‚úÖ');loadKeys();}});}
function copyKey(k){navigator.clipboard?.writeText(k);toast('üìã Copiada!');}

// ========== ACTIONS ==========
function cmd(c,d){if(currentRole!=='admin'&&!['refresh'].includes(c)){toast('‚õî');return;}if(socket)socket.emit(c,d);}
function connectSrv(){const ip=document.getElementById('cIp').value.trim();if(!ip)return;socket.emit('connect_server',ip);document.getElementById('cIp').value='';toast('üîó Conectando...');}
function connectSrv2(){const ip=document.getElementById('cIp2').value.trim();if(!ip)return;socket.emit('connect_server',ip);document.getElementById('cIp2').value='';toast('üîó Conectando...');}
function addMsg(){const m=document.getElementById('newMsg').value.trim();if(!m)return;socket.emit('addMsg',m);document.getElementById('newMsg').value='';}
function delMsg(i){socket.emit('delMsg',i);}
function setInt(){const v=document.getElementById('intInp').value;if(v)socket.emit('setIntervalo',parseInt(v));}
function setUname(){const v=document.getElementById('unameInp').value.trim();if(v)socket.emit('setUsername',v);}
function addBl(){const v=document.getElementById('blInp').value.trim();if(!v)return;socket.emit('addBlacklist',v);document.getElementById('blInp').value='';}
function addTag(k){const t=prompt('Tag:');if(t)socket.emit('addServerTag',{serverKey:k,tag:t.trim()});}
function setCat(k){const c=prompt('Categoria:');if(c)socket.emit('setServerCategory',{serverKey:k,categoria:c.trim()});}
function scanSrv(k){socket.emit('scanVulnerabilities',k);toast(`üîç Scan: ${k}`);}
function dlChat(){if(socket)socket.emit('downloadChat');}

// ========== HELPERS ==========
function esc(t){if(!t)return'';return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function cleanMotd(m){if(!m)return'';if(typeof m==='object'){if(m.text!==undefined){let r=cleanMotd(m.text);if(m.extra)r+=m.extra.map(e=>cleanMotd(e)).join('');return r;}return m.translate||'';}return String(m).replace(/¬ß[0-9a-fk-or]/gi,'').trim();}
function toast(m){const c=document.getElementById('toastC');const t=document.createElement('div');t.className='toast';t.textContent=m;c.appendChild(t);setTimeout(()=>t.remove(),4000);}
function dlJSON(d,f){const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=f;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);toast(`üì• ${f}`);}

// ========== KEYBOARD ==========
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&!document.getElementById('loginOverlay').classList.contains('hidden'))doLogin();});

// ========== PERIODIC ==========
setInterval(()=>{
    if(socket?.connected){socket.emit('getTopServerChat');}
    document.getElementById('sMsgs').textContent=allChat.length;
},15000);
setInterval(()=>{if(currentPage==='keys'&&currentRole==='admin')loadKeys();},30000);
</script>
</body>
</html>